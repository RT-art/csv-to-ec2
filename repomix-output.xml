This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
manage.sh
README.md
sample.csv
src/app.py
template.yaml
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# SAM build artifacts

.aws-sam/

# Local configuration file

.sam_outputs
</file>

<file path="manage.sh">
#!/bin/bash

# csv-to-ec2 SAMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ç®¡ç†ã‚’è¡Œã†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

# ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢
set -e

# --- è¨­å®š ---
# SAMãƒ‡ãƒ—ãƒ­ã‚¤ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆï¼ˆS3ãƒã‚±ãƒƒãƒˆåãªã©ï¼‰ã‚’ä¿å­˜ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«
CONFIG_FILE=".sam_outputs"

# CloudFormationã®ã‚¹ã‚¿ãƒƒã‚¯åï¼ˆå¤‰æ›´å¯èƒ½ï¼‰
STACK_NAME="csv-to-ec2-stack"

# AWSãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è‡ªå‹•å–å¾—ã€‚è¨­å®šãŒãªã‘ã‚Œã°æ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
REGION=$(aws configure get region)
[ -z "$REGION" ] && REGION="ap-northeast-1"

# --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
# ä½¿ã„æ–¹ã‚’è¡¨ç¤º
usage() {
    echo "ä½¿ã„æ–¹: $0 {deploy|upload|delete}"
    echo
    echo "ã‚³ãƒãƒ³ãƒ‰:"
    echo "  deploy   : AWS SAMã‚¹ã‚¿ãƒƒã‚¯ã‚’ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹ã€S3ãƒã‚±ãƒƒãƒˆã€Lambdaã‚’ä½œæˆã—ã¾ã™ã€‚"
    echo "  upload   : S3ãƒã‚±ãƒƒãƒˆã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¾ã™ã€‚"
    echo "             å¼•æ•°ãªã—ã®å ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å­˜åœ¨ã™ã‚‹å˜ä¸€ã®.csvãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•ã§æ¤œå‡ºã—ã¾ã™ã€‚"
    echo "  delete   : ä½œæˆã•ã‚ŒãŸã™ã¹ã¦ã®AWSãƒªã‚½ãƒ¼ã‚¹ï¼ˆSAMã‚¹ã‚¿ãƒƒã‚¯ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚"
    echo
}

# --- ãƒ¡ã‚¤ãƒ³é–¢æ•° ---
# SAMã‚¹ã‚¿ãƒƒã‚¯ã®ãƒ“ãƒ«ãƒ‰ã¨ãƒ‡ãƒ—ãƒ­ã‚¤
deploy_stack() {
    echo ">>> SAMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ã„ã¾ã™..."
    sam build

    echo ">>> ã‚¹ã‚¿ãƒƒã‚¯ '$STACK_NAME' ã‚’ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ '$REGION' ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã„ã¾ã™..."
    # --guided ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã«å½¹ç«‹ã¡ã¾ã™ã€‚2å›ç›®ä»¥é™ã¯ samconfig.toml ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
    sam deploy --stack-name "$STACK_NAME" --region "$REGION" --capabilities CAPABILITY_IAM --resolve-s3 --confirm-changeset

    echo ">>> ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã€‚S3ãƒã‚±ãƒƒãƒˆåã‚’å–å¾—ã—ã¦ã„ã¾ã™..."

    # CloudFormationã‚¹ã‚¿ãƒƒã‚¯ã®ã‚¢ã‚¦ãƒˆãƒ—ãƒƒãƒˆã‹ã‚‰S3ãƒã‚±ãƒƒãƒˆåã‚’å–å¾—
    BUCKET_NAME=$(aws cloudformation describe-stacks \
        --stack-name "$STACK_NAME" \
        --query "Stacks[0].Outputs[?OutputKey=='S3BucketName'].OutputValue" \
        --output text \
        --region "$REGION")

    if [ -z "$BUCKET_NAME" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: S3ãƒã‚±ãƒƒãƒˆåã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚"
        echo "AWSãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚¹ã‚¿ãƒƒã‚¯ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi

    # å¾Œç¶šã® 'upload' ã‚³ãƒãƒ³ãƒ‰ã§ä½¿ã†ãŸã‚ã€ãƒã‚±ãƒƒãƒˆåã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    echo "S3_BUCKET_NAME=$BUCKET_NAME" > "$CONFIG_FILE"

    echo "âœ” ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã€‚"
    echo "  S3ãƒã‚±ãƒƒãƒˆ '$BUCKET_NAME' ã®æº–å‚™ãŒã§ãã¾ã—ãŸã€‚"
    echo "  './manage.sh upload' ã‚³ãƒãƒ³ãƒ‰ã§EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã§ãã¾ã™ã€‚"
}

# S3ãƒã‚±ãƒƒãƒˆã¸CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
upload_csv() {
    if [ ! -f "$CONFIG_FILE" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« '$CONFIG_FILE' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        echo "æœ€åˆã« './manage.sh deploy' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi

    # è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ãƒã‚±ãƒƒãƒˆåã‚’èª­ã¿è¾¼ã‚€
    source "$CONFIG_FILE"

    if [ -z "$S3_BUCKET_NAME" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: '$CONFIG_FILE' å†…ã« S3_BUCKET_NAME ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        exit 1
    fi

    CSV_FILE="$1" # å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
    if [ -z "$CSV_FILE" ]; then
        # å¼•æ•°ãŒãªã„å ´åˆã€ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‹ã‚‰.csvãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œå‡º
        shopt -s nullglob
        CSV_FILES=(*.csv)
        shopt -u nullglob

        if [ ${#CSV_FILES[@]} -eq 1 ]; then
            CSV_FILE="${CSV_FILES[0]}"
            echo ">>> CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã—ãŸ: '$CSV_FILE'"
        elif [ ${#CSV_FILES[@]} -eq 0 ]; then
            echo "ã‚¨ãƒ©ãƒ¼: ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
            echo "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„:"
            echo "  ä½¿ç”¨ä¾‹: ./manage.sh upload sample.csv"
            exit 1
        else
            echo "ã‚¨ãƒ©ãƒ¼: è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ã¦ãã ã•ã„:"
            printf " - %s\n" "${CSV_FILES[@]}"
            echo "  ä½¿ç”¨ä¾‹: ./manage.sh upload ${CSV_FILES[0]}"
            exit 1
        fi
    fi

    if [ ! -f "$CSV_FILE" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: CSVãƒ•ã‚¡ã‚¤ãƒ« '$CSV_FILE' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚"
        exit 1
    fi

    echo ">>> '$CSV_FILE' ã‚’ãƒã‚±ãƒƒãƒˆ '$S3_BUCKET_NAME' ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã„ã¾ã™..."
    aws s3 cp "$CSV_FILE" "s3://$S3_BUCKET_NAME/"

    echo "âœ” ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™ã€‚"
}

# SAMã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤
delete_stack() {
    echo ">>> SAMã‚¹ã‚¿ãƒƒã‚¯ '$STACK_NAME' ã‚’ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ '$REGION' ã‹ã‚‰å‰Šé™¤ã—ã¾ã™..."
    echo "!!! æ³¨æ„: ã“ã®æ“ä½œã«ã‚ˆã‚Šã€æœ¬ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½œæˆã•ã‚ŒãŸã™ã¹ã¦ã®AWSãƒªã‚½ãƒ¼ã‚¹ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚!!!"

    sam delete --stack-name "$STACK_NAME" --region "$REGION" --no-prompts

    # ãƒ­ãƒ¼ã‚«ãƒ«ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    if [ -f "$CONFIG_FILE" ]; then
        rm "$CONFIG_FILE"
    fi

    echo "âœ” ã‚¹ã‚¿ãƒƒã‚¯ã®å‰Šé™¤ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
}

# --- ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ ---
# å¿…è¦ãªã‚³ãƒãƒ³ãƒ‰ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
if ! command -v sam &> /dev/null || ! command -v aws &> /dev/null; then
    echo "ã‚¨ãƒ©ãƒ¼: 'sam' ãŠã‚ˆã³ 'aws' CLIãŒå¿…è¦ã§ã™ã€‚"
    echo "ã“ã‚Œã‚‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã€AWSèªè¨¼æƒ…å ±ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚"
    exit 1
fi

# ãƒ¡ã‚¤ãƒ³ã®ã‚³ãƒãƒ³ãƒ‰æŒ¯ã‚Šåˆ†ã‘
case "$1" in
    deploy)
        deploy_stack
        ;;
    upload)
        # 2ç•ªç›®ã®å¼•æ•°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åï¼‰ã‚’uploadé–¢æ•°ã«æ¸¡ã™
        upload_csv "$2"
        ;;
    delete)
        delete_stack
        ;;
    ""|--help|-h) # å¼•æ•°ãªã—ã€ã¾ãŸã¯ãƒ˜ãƒ«ãƒ—ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å ´åˆ
        usage
        exit 0
        ;;
    *)
        echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰ '$1'"
        usage
        exit 1
        ;;
esac

exit 0
</file>

<file path="src/app.py">
import boto3
import csv
import os
import urllib.parse

s3 = boto3.client('s3')
ec2 = boto3.client('ec2')

def lambda_handler(event, context):
    """
    S3ã¸ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã«å®Ÿè¡Œã•ã‚Œã‚‹ãƒ¡ã‚¤ãƒ³é–¢æ•°ã€‚
    CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã«åŸºã¥ãã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
    ä½œæˆã•ã‚Œã‚‹ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€SSMï¼ˆSystems Managerï¼‰ãŒæœ‰åŠ¹åŒ–ã•ã‚Œã¾ã™ã€‚
    """
    # ã‚¤ãƒ™ãƒ³ãƒˆæƒ…å ±ã‹ã‚‰ãƒã‚±ãƒƒãƒˆåã¨ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆã‚­ãƒ¼ï¼‰ã‚’å–å¾—
    bucket = event['Records'][0]['s3']['bucket']['name']
    # URLã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸã‚­ãƒ¼ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
    key = urllib.parse.unquote_plus(event['Records'][0]['s3']['object']['key'], encoding='utf-8')

    print(f"å‡¦ç†é–‹å§‹: s3://{bucket}/{key}")

    try:
        # ç’°å¢ƒå¤‰æ•°ã‹ã‚‰å¿…é ˆè¨­å®šã‚’å–å¾—
        target_subnet_id = os.environ['TARGET_SUBNET_ID']
        ssm_instance_profile_arn = os.environ['SSM_INSTANCE_PROFILE_ARN']
    except KeyError as e:
        print(f"è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼: ç’°å¢ƒå¤‰æ•° {e} ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚")
        raise

    try:
        # S3ã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ã—ã¦èª­ã¿è¾¼ã‚€
        response = s3.get_object(Bucket=bucket, Key=key)
        # splitlines()ã§å„è¡Œã‚’ãƒªã‚¹ãƒˆã«
        lines = response['Body'].read().decode('utf-8').splitlines()
        reader = csv.DictReader(lines)

        for row in reader:
            try:
                ami_id = row.get('ami_id')
                instance_type = row.get('instance_type')

                # å¿…é ˆé …ç›®ãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—
                if not all([ami_id, instance_type]):
                    print(f"å¿…é ˆé …ç›®ï¼ˆami_id, instance_typeï¼‰ãŒä¸è¶³ã—ã¦ã„ã‚‹ãŸã‚ã€ã“ã®è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™: {row}")
                    continue
                
                print(f"EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆä¸­... AMI: {ami_id}, ã‚¿ã‚¤ãƒ—: {instance_type}")

                # EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆAPIã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
                run_instances_params = {
                    'ImageId': ami_id,
                    'InstanceType': instance_type,
                    'SubnetId': target_subnet_id,
                    'MinCount': 1,
                    'MaxCount': 1,
                    # SSMã‚’æœ‰åŠ¹ã«ã™ã‚‹ãŸã‚ã®IAMã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¸¸ã«ã‚¢ã‚¿ãƒƒãƒ
                    'IamInstanceProfile': {
                        'Arn': ssm_instance_profile_arn
                    },
                    'TagSpecifications': [{
                        'ResourceType': 'instance',
                        'Tags': [
                            {'Key': 'Name', 'Value': f'auto-created-from-{os.path.basename(key)}'},
                            {'Key': 'SourceFile', 'Value': f's3://{bucket}/{key}'}
                        ]
                    }]
                }
                
                instance_response = ec2.run_instances(**run_instances_params)
                
                instance_id = instance_response['Instances'][0]['InstanceId']
                print(f"ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ: {instance_id}")

            except Exception as e:
                # è¡Œå˜ä½ã®ã‚¨ãƒ©ãƒ¼ã¯ãƒ­ã‚°ã«å‡ºåŠ›ã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ
                print(f"è¡Œã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™: {row}, ã‚¨ãƒ©ãƒ¼: {e}")

    except Exception as e:
        print(f"è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        # è‡´å‘½çš„ãªã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯Lambdaã®å®Ÿè¡Œã‚’å¤±æ•—ã•ã›ã‚‹
        raise

    print(f"å‡¦ç†å®Œäº†: s3://{bucket}/{key}")
    return {'status': 'success'}
</file>

<file path="sample.csv">
ami_id,instance_type
ami-0c55b159cbfafe1f0,t2.micro
ami-0c55b159cbfafe1f0,t3.small
</file>

<file path="template.yaml">
AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: >-
  S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è‡ªå‹•ä½œæˆã™ã‚‹ã‚¹ã‚¿ãƒƒã‚¯ã€‚
  VPCã€ã‚µãƒ–ãƒãƒƒãƒˆã€S3ãƒã‚±ãƒƒãƒˆã€Lambdaé–¢æ•°ã€ãŠã‚ˆã³EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”¨ã®IAMãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
  ä½œæˆã•ã‚Œã‚‹EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§SSMï¼ˆSystems Managerï¼‰ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã™ã€‚

Resources:

  # ------------------------------------------------------------
  # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ãƒªã‚½ãƒ¼ã‚¹
  # ------------------------------------------------------------
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-VPC"

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-IGW"

  VPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true # ãƒ‘ãƒ–ãƒªãƒƒã‚¯IPã‚’è‡ªå‹•å‰²ã‚Šå½“ã¦
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-PublicSubnet"

  RouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-RouteTable"

  DefaultRoute:
    Type: AWS::EC2::Route
    DependsOn: VPCGatewayAttachment
    Properties:
      RouteTableId: !Ref RouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet
      RouteTableId: !Ref RouteTable

  # ------------------------------------------------------------
  # EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”¨IAMãƒ­ãƒ¼ãƒ«ï¼ˆSSMæœ‰åŠ¹åŒ–ã®ãŸã‚ï¼‰
  # ------------------------------------------------------------
  EC2InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: "ec2.amazonaws.com"
            Action: "sts:AssumeRole"
      # Systems Managerã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®AWSç®¡ç†ãƒãƒªã‚·ãƒ¼
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-EC2InstanceRole"

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2InstanceRole

  # ------------------------------------------------------------
  # S3ãƒã‚±ãƒƒãƒˆï¼ˆCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
  # ------------------------------------------------------------
  CsvFileBucket:
    Type: AWS::S3::Bucket
    Properties:
      # ãƒã‚±ãƒƒãƒˆåã¯ã‚°ãƒ­ãƒ¼ãƒãƒ«ã§ä¸€æ„ã«ã™ã‚‹ãŸã‚ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆIDã¨ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å«ã‚ã‚‹
      BucketName: !Sub "csv-to-ec2-${AWS::AccountId}-${AWS::Region}"
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  # ------------------------------------------------------------
  # Lambdaé–¢æ•° & å®Ÿè¡Œãƒ­ãƒ¼ãƒ«
  # ------------------------------------------------------------
  CsvToEc2Function:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-CsvToEc2Function"
      Handler: app.lambda_handler
      Runtime: python3.12 # LTSã§ã‚ã‚‹Python 3.12ã‚’ä½¿ç”¨
      CodeUri: src/
      Timeout: 60
      Environment:
        Variables:
          TARGET_SUBNET_ID: !Ref PublicSubnet
          SSM_INSTANCE_PROFILE_ARN: !GetAtt EC2InstanceProfile.Arn
      Policies:
        # 1. S3ãƒã‚±ãƒƒãƒˆã‹ã‚‰CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿å–ã‚‹æ¨©é™
        - S3ReadPolicy:
            BucketName: !GetAtt CsvFileBucket.Name
        # 2. EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã€ã‚¿ã‚°ä»˜ã‘ã—ã€IAMãƒ­ãƒ¼ãƒ«ã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹æ¨©é™
        - Statement:
            - Effect: Allow
              Action:
                - ec2:RunInstances
                - ec2:CreateTags
              Resource: "*" # æœ¬ç•ªç’°å¢ƒã§ã¯ã€ä½œæˆã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã«å¿œã˜ã¦ã‚ˆã‚Šå³å¯†ãªæ¨©é™è¨­å®šã‚’æ¨å¥¨
            - Effect: Allow
              Action: iam:PassRole
              Resource: !GetAtt EC2InstanceRole.Arn # ç‰¹å®šã®IAMãƒ­ãƒ¼ãƒ«ã®ã¿ã‚’EC2ã«æ¸¡ã™ã“ã¨ã‚’è¨±å¯
      # Lambdaã®ãƒˆãƒªã‚¬ãƒ¼è¨­å®š (S3ã¸ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ)
      Events:
        S3CsvUpload:
          Type: S3
          Properties:
            Bucket: !Ref CsvFileBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                  - Name: suffix
                    Value: .csv

Outputs:
  S3BucketName:
    Description: "CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹S3ãƒã‚±ãƒƒãƒˆå"
    Value: !Ref CsvFileBucket
  VpcId:
    Description: "ä½œæˆã•ã‚ŒãŸVPCã®ID"
    Value: !Ref VPC
  PublicSubnetId:
    Description: "ä½œæˆã•ã‚ŒãŸãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚µãƒ–ãƒãƒƒãƒˆã®ID"
    Value: !Ref PublicSubnet
</file>

<file path="README.md">
# ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹EC2ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚° from CSV âœ¨

S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ãã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’è‡ªå‹•ã§ä½œæˆã™ã‚‹AWS SAMã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚

ç®¡ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ (`manage.sh`) ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€AWSãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‹ã‚‰ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆã®ãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¾ã§ã€ç°¡å˜ãªã‚³ãƒãƒ³ãƒ‰ã§å®Ÿè¡Œã§ãã¾ã™ã€‚ä½œæˆã•ã‚Œã‚‹ã™ã¹ã¦ã®EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€**ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§SSMï¼ˆAWS Systems Managerï¼‰ãŒæœ‰åŠ¹åŒ–**ã•ã‚Œã¾ã™ã€‚

## ğŸ›ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

![ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³](images/ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³.png)

1.  ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ `manage.sh upload` ã‚³ãƒãƒ³ãƒ‰ã§CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’S3ãƒã‚±ãƒƒãƒˆã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚
2.  S3ã¸ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ã€Lambdaé–¢æ•°ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
3.  Lambdaé–¢æ•°ã¯CSVãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’èª­ã¿å–ã‚Šã¾ã™ã€‚
4.  CSVã®å„è¡Œã§æŒ‡å®šã•ã‚ŒãŸAMI IDã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ—ã«åŸºã¥ãã€EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚
5.  ä½œæˆã•ã‚Œã‚‹ã™ã¹ã¦ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€SSMæ¥ç¶šã‚’è¨±å¯ã™ã‚‹IAMãƒ­ãƒ¼ãƒ«ãŒã‚¢ã‚¿ãƒƒãƒã•ã‚Œã¾ã™ã€‚

## ğŸš€ ä½¿ã„æ–¹

**å‰ææ¡ä»¶:**

  - [AWS CLI](https://aws.amazon.com/cli/) ã¨ [AWS SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-sam-cli-install.html) ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã€‚
  - AWSèªè¨¼æƒ…å ±ãŒè¨­å®šæ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ (`aws configure`)ã€‚

-----

### **Step 1: ãƒ‡ãƒ—ãƒ­ã‚¤ (åˆå›ã®ã¿)**

æœ€åˆã«ã€AWSç’°å¢ƒã«å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ä¸€å¼ï¼ˆVPC, S3ãƒã‚±ãƒƒãƒˆ, Lambdaé–¢æ•°ãªã©ï¼‰ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ã“ã®æ“ä½œã¯ä¸€åº¦ã ã‘è¡Œã„ã¾ã™ã€‚

1.  ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«å®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ã—ã¾ã™ã€‚

    ```bash
    chmod +x manage.sh
    ```

2.  ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```bash
    ./manage.sh deploy
    ```

    CloudFormationã‚¹ã‚¿ãƒƒã‚¯ã®ä½œæˆãŒå®Œäº†ã™ã‚Œã°ã€ç’°å¢ƒã®æº–å‚™ã¯å®Œäº†ã§ã™ã€‚

-----

### **Step 2: EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®ä½œæˆ**

1.  **CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨æ„ã—ã¾ã™ã€‚**
    `sample.csv` ã‚’å‚è€ƒã«ã€ä½œæˆã—ãŸã„EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®æƒ…å ±ã‚’è¨˜è¿°ã—ã¾ã™ã€‚

      - **`ami_id`** ã¨ **`instance_type`** ã®åˆ—ã¯**å¿…é ˆ**ã§ã™ã€‚

    **`sample.csv` ã®ä¾‹:**

    ```csv
    ami_id,instance_type
    ami-0abcdef1234567890,t2.micro
    ami-0abcdef1234567890,t3.small
    ```

2.  **CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚**
    `upload` ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Lambdaé–¢æ•°ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã€CSVã®å†…å®¹ã«åŸºã¥ã„ã¦EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè‡ªå‹•ã§ä½œæˆã•ã‚Œã¾ã™ã€‚

      - **ã€æ¨å¥¨ã€‘å˜ä¸€ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•æ¤œå‡º**
        ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒ1ã¤ã ã‘å­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æŒ‡å®šã—ãªãã¦ã‚‚è‡ªå‹•ã§æ¤œçŸ¥ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚

        ```bash
        # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚ã‚‹å”¯ä¸€ã®.csvãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        ./manage.sh upload
        ```

      - **ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®š**
        è¤‡æ•°ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã‚„ã€ç‰¹å®šã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã—ãŸã„å ´åˆã¯ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¼•æ•°ã¨ã—ã¦æ¸¡ã—ã¾ã™ã€‚

        ```bash
        # my_instances.csv ã‚’æŒ‡å®šã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        ./manage.csv upload my_instances.csv
        ```

-----

### **Step 3: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ— ğŸ—‘ï¸**

ã“ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½œæˆã—ãŸã™ã¹ã¦ã®AWSãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
./manage.sh delete
```

VPCã€S3ãƒã‚±ãƒƒãƒˆã€Lambdaé–¢æ•°ã€IAMãƒ­ãƒ¼ãƒ«ãªã©ã€é–¢é€£ãƒªã‚½ãƒ¼ã‚¹ãŒä¸€æ‹¬ã§å‰Šé™¤ã•ã‚Œã¾ã™ã€‚
</file>

</files>
